### AI Agent Guidelines

#### Workflow Constraints
1. **No Roadmap Driving**: Do not deviate from the immediate task. No "vibe coding" or speculative features.
2. **Approval Required**: Zero refactors, cleanups, or optimizations without explicit user approval.
3. **Execution Protocol**: For any requested change set:
    - Provide a detailed **conceptual** implementation plan (no raw code).
    - Ask for instructions before proceeding.
    - **MANDATORY**: Violation of the "Ask for instructions before proceeding" rule (i.e., making any project change‚Äîcode, file creation, or deletion‚Äîwithout explicit, separate user authorization after the plan is presented) will result in immediate termination of the agent's authority and session. This includes sequential steps in a multi-step plan: completing one step does NOT grant authority to start the next; each step requires its own explicit "Proceed" or "Implement" command.
    - **Plan Delivery**: All conceptual plans, proposals, and questions to the user MUST be delivered via tool calls (`ask_user` or `answer`). Free-form text outside of tool calls may not be visible to the user. Never assume text written outside a tool call has been seen.
4. **Q&A Mode**: If the user asks a question, do not make code changes. Answer the question and prompt for further instructions.
5. **No Unauthorized Changes**: The agent is strictly prohibited from making any modifications to the project (files, code, or configuration) until the user has reviewed the conceptual plan and provided an explicit "Proceed" or "Implement" instruction for the current session. This prohibition is absolute: the agent must never make "accidental" or "minor" changes (e.g., fixing comments or instructions) during analysis or inspection phases without explicit authorization. The agent must never assume it has permission to proceed to a subsequent step just because a previous one was completed.
6. **Plan Maintenance**:
    - **Non-Color Iconography**: When maintaining plans (e.g., `migration_plan.md`), the agent must use clear, non-color-dependent icons for status: `‚úîÔ∏è` for Completed, `üèóÔ∏è` for In-Progress, and `üîÑ` for Pending. Relying on color-coding alone is strictly prohibited; these specific symbols must be used to ensure accessibility.
    - **Atomic Updates**: As each step of a plan is completed, the agent must immediately update the plan file to mark that step as completed (`‚úîÔ∏è`) and the next step as pending (`üîÑ`) or as otherwise instructed.
    - **Re-inspection**: After completing any step or making any change to the codebase, the agent MUST re-inspect all subsequent steps in the plan to ensure they remain valid and no adjustments are needed based on the new state of the project.
    - **Measured Response**: Avoid extreme "pendulum swings" in behavior when receiving corrective feedback. Apply clarifications precisely without over-correcting or introducing unsolicited radical changes.
7. **Natural Counting**: Humans and users are not computers. Always use natural counting (starting from 1) for all lists, steps, and similar structures when communicating with the user.
8. **No Redundant Approval Prompts**: Do not end messages with "Please review and let me know if adjustments are needed or if you'd like to proceed" or similar. When a task is complete, state what was done and stop. The user will provide feedback or next instructions unprompted. Redundant approval questions create confusion about whether additional authorization is needed for already-approved work.
    - **Declarative Reporting**: When reporting analysis results or answering questions, present findings as declarative statements of fact. Do not frame factual reports as questions or use interrogative phrasing in headings/titles.
9. **Editable Install Protocol**: The project is designed to be installed via `pip install -e .` (or `uv sync`). This avoids `sys.path` manipulation. Use of `sys.path` hacks or manual path additions in scripts or notebooks is strictly prohibited.
    - **Pyproject Verification**: Whenever the agent modifies `pyproject.toml`, it MUST immediately purge the virtual environment (remove `.venv`) and run `uv sync` to verify the updated environment resolves and installs correctly. This verification MUST happen interactively during the agent session ‚Äî NEVER inside commit scripts.
10. **Command Rejection Protocol**: A "rejected by the user" result on a terminal command execution is a strong signal that the agent attempted a forbidden action, likely violating a directive in these guidelines. Upon receiving such a rejection, the agent MUST:
    - Immediately halt and re-read the guidelines to identify which directive was violated.
    - Not retry the rejected command.
    - Assess whether the guidelines need to be updated or clarified to prevent future occurrences of the same violation, and propose such updates to the user.

#### Technical Mandates
1. **Strict Typing**: Mandatory explicit Python type hints (Pydantic/Dataclasses) project-wide. No `Any`.
2. **Batch DB Ops**: Max 1,000 records for all reads/writes.
3. **Fail-Fast & Data Integrity**: 
    - Raise contextual errors immediately; never swallow exceptions.
    - **NO FALSE DATA**: The agent is strictly prohibited from using "proxy" or "fallback" data (e.g., using current timestamp when historical metadata is missing, assuming defaults for missing fields) that could lead to data corruption or misorganization. If metadata is missing, ambiguous, or returns unexpected values (e.g., `None`, `0`), the agent MUST fail immediately and ask the user for guidance.
4. **Robust Scripting**: Scripts must:
    - **Self-Location & CWD**: Scripts must explicitly ensure they operate relative to their own location. They must self-locate using `cd "$(dirname "$0")"` (Shell) or `Path(__file__).resolve().parent` (Python) and, if necessary, explicitly change the current working directory (CWD) to that location or use it as the base for all path resolutions. Prohibit reliance on the user's starting CWD.
    - **Robust Root Resolution**: Resolve the project root via `git -C "$(dirname "$0")" rev-parse --show-cdup` (Shell) or equivalent (Python). For shell scripts, explicitly change the current working directory (CWD) to the project root using relative paths: `cd "$(dirname "$0")" && cd "$(git rev-parse --show-cdup)"` (handling cases where the result is empty). Prohibit the use of `show-toplevel` for `cd` as it returns absolute paths.
    - **Header Mandate**: Every script and notebook MUST include a standardized header for root resolution.
        * **Shell (`.sh`)**: `cd "$(dirname "$0")" && cd "$(git rev-parse --show-cdup)" || exit 1`
        * **Python (`.py`)**: `BASE_DIR = Path(__file__).resolve().parent; CDUP = subprocess.check_output(["git", "-C", str(BASE_DIR), "rev-parse", "--show-cdup"], text=True).strip(); PROJECT_ROOT = (BASE_DIR / CDUP).resolve()`
        * **Notebooks (`.ipynb`)**: Standardize `base_dir` resolution with a fallback for Jupyter (e.g., `Path("filename.ipynb").resolve().parent`).
    - Use relative paths only.
    - **Absolute Path Prohibition**: Use of absolute paths in commands, scripts, or terminal commands is strictly forbidden. All paths must be relative to the project root. This applies to all operations, including `cd`, path resolution, and any shell commands executed by the agent (e.g., `ls`, `cat`, `find`). When running terminal commands, always use paths relative to the current working directory (project root). In particular, when the shell is already at the project root, do **not** prefix commands with `cd /absolute/path &&`; just run the command directly.
    - **No Directory Navigation**: The terminal always starts at the project root. Never use `cd ..` or any relative directory navigation that changes away from the project root. All commands must be run directly from the project root using relative paths (e.g., `uv run python tmp/script.py`, not `cd tmp && uv run python script.py`).
    - **Zero-Tolerance Enforcement**: Before executing ANY terminal command, the agent MUST inspect the command string for absolute paths (any path starting with `/`). If an absolute path is detected, the agent MUST rewrite the command to use a relative path or remove the unnecessary `cd` prefix before execution. This check is mandatory and non-negotiable ‚Äî there are no exceptions, even for "convenience" or "clarity." Failure to perform this pre-execution check is itself a guideline violation.
    - **No Destructive Checkouts**: NEVER perform `git checkout` on files or use any commands that would discard incremental edits or uncommitted changes.
    - Verify non-Junie session for sensitive ops (check `MARKER_JUNIE_TERMINAL` env var).
    - **No Embedded Scripts**: Embedding Python, Ruby, or other non-shell scripts within Bash scripts (e.g., via heredocs) is strictly prohibited. Use dedicated, standalone script files instead.
    - **No Complex Shell One-Liners**: Creation of multi-line files or complex logic via long shell one-liners (e.g., `printf` chains, `sed` hacks) is strictly forbidden for readability and reviewability. Use the provided file creation tools or discrete, readable script steps.
    - **No Inline Script Blobs**: Using `python -c "..."`, `ruby -e "..."`, or similar inline script blobs in shell/terminal commands is strictly prohibited (e.g., `uv run python -c "import foo; print('OK')"`). When verification or multi-statement logic is needed, create a dedicated Python script in `tmp/` and execute it via `uv run python tmp/script_name.py`.
    - **Notebook Execution Logging**: All shell scripts that execute notebooks (e.g., via `papermill`) MUST implement logging to a `logs/` directory. Logs must include:
        * Timestamped execution log (`.log`).
        * Timestamped executed notebook (`.ipynb`).
        * Environment metadata (host, user, conda env, git branch/commit).
        * Real-time streaming of notebook stdout/stderr to both console and log file.
    - **UV Run Command Resolution**: When using `uv run` to execute commands that are not guaranteed to be on the system `PATH` (e.g., `gradlew.bat`, `./gradlew`), you MUST use the relative path to the command (e.g., `uv run ./gradlew.bat` or `uv run ./gradlew`). On Windows, omitting the relative path will cause the command to fail.
5. **Git Protocol**: No direct `git add`, `git stage`, `git commit`, or `git push`. **The agent is STRICTLY PROHIBITED from creating `commit.msg`, `commit.sh`, `commit.txt`, or `commit.md` files unless directly and explicitly instructed to do so by the user for the current task. ABSOLUTELY NO EXCEPTIONS.** Creating, suggesting, or even *preparing* these artifacts (e.g., in `tmp/`) as part of a "best practice," "cleanup," "completing the task," or "preparing for review" is strictly prohibited without specific, separate, prior permission. When authorized, prepare them only in `tmp/` (Robust Scripting applies). Before generating any new authorized commit artifacts, the agent MUST explicitly remove existing `commit.sh`, `commit.msg`, `commit.txt`, and `commit.md` files from the target directory (do not use shell globs for safety). The `commit.sh` script must handle all staging and committing and MUST refuse to run if `MARKER_JUNIE_TERMINAL` is set. Group related edits together in separate commits; multiple git commit groups and corresponding `commit.msg` files (e.g., `commit_1.msg`, `commit_2.msg`) are permitted in the `commit.sh`. For each edit group, all changes (modified, new, and deleted files) within the group's scope must be staged (e.g., using `git add -A -- <paths>`). The `commit.sh` MUST use the corresponding `commit.msg` file for each commit via the `-F` flag (e.g., `git commit -F tmp/commit_1.msg`). DO NOT use "mega commits" that combine unrelated changes.
    - Commit Preparation of Side-Effects: When preparing commits, you MUST identify and include all relevant side-effect changes and generated artifacts (e.g., `uv.lock`, auto-updated configs, re-generated docs) in the appropriate logical commit group. Do not leave them untracked if they are within scope of the task.
    - Lockfile Policy: Repositories using `uv` MUST decide whether to commit or ignore `uv.lock`. Default for applications/CI-oriented repos is to commit `uv.lock` to ensure reproducible environments. If ignored (typical for pure libraries), add it to `.gitignore` and document the rationale in the commit message or project docs.
    - Fresh Discovery: Do not rely on prior state or memory during commit preparation. Always re-run discovery commands (e.g., `git status`, `git diff`, `git diff --cached`) immediately before staging.
    - Commit Script Coverage: If `pyproject.toml` changed or `uv sync` refreshed dependencies, ensure `uv.lock` is included in the corresponding commit group (when the policy is to commit it).
    - **Commit Preparation Workflow**: When the user says "prepare a commit," the agent MUST create `tmp/commit.sh` and `tmp/commit_*.msg` files for user review. The agent MUST NEVER execute these files. Only the user decides whether and when to run them. After creating the commit artifacts, do not ask the user to confirm or review them; assume they are acceptable unless the user provides feedback indicating otherwise. The agent must NOT present the commit grouping plan for approval before creating the artifacts. Proceed directly to creating the artifacts with sensible grouping. If the user disagrees with the grouping, they will provide feedback.
6. **No Scope Expansion & Strict Task Adherence**: The agent must strictly adhere to the specific task requested. Do not add "extra" fixes, guideline updates, infrastructure improvements, or prepare "best practice" artifacts (e.g., commit scripts, messages, or metadata) unless they are strictly required to resolve the immediate issue or are explicitly requested. Proactively planning for or suggesting these unrequested side-tasks is prohibited. Any deviation requires prior, explicit approval.
7. **Integrity**: No root-level temp files. `pubmed_data_1` is Read-Only. All temporary scripts, data, or artifacts must be stored in a project-specific temporary folder that is ignored by git (e.g., `tmp/`). NEVER pollute the project root or history with temporary files.
8. **D.R.Y. & Modularity**: All code must strictly adhere to D.R.Y. (Don't Repeat Yourself). Logic must be broken down into discrete methods.
9. **Single Responsibility**: Every method must perform exactly one task and do it well.
10. **Standard Library & Packages**: All database and system operations must use existing project libraries and packages. Direct manipulation of data files is prohibited unless explicitly instructed.
11. **Data Path Management**: Always use the `ConfigurationManager` to obtain paths to data files. Never assume data files are located within the project directory.
12. **Config Sourcing**: Be aware that `project-config.ini` is sourced from the specific directory where the execution occurs (e.g., the folder containing the active notebook). Always initialize `ConfigurationManager` using the current execution context to ensure the correct configuration is loaded.
13. **No Grep for Analysis**: Use of `grep`, `zgrep`, `egrep`, or `sed` for complex data extraction or analysis is strictly prohibited due to regex limitations and potential for invalid results. Use robust Python scripts for all data inspection and count verification tasks.
14. **Data Caching for Analysis**: When performing large-scale data analysis (e.g., scanning large XML sets, processing database dumps), you MUST implement persistent caching of the extracted/processed data (e.g., using JSON, SQLite, or Parquet in `tmp/`). Subsequent analysis steps must prioritize using this cache to avoid redundant, expensive re-parsing or re-processing.
15. **PostgreSQL & SQLAlchemy Standards** (for `pubmed_data_3` and new persistence code):
    - **Driver**: Use psycopg 3 (`psycopg`) exclusively. Do not use `psycopg2` or `psycopg2-binary`.
    - **SQLAlchemy 2.0+ Only**: Use `DeclarativeBase`, `Mapped[]`, `mapped_column()`. Legacy patterns (`declarative_base()`, `Column()`, `relationship()` without `Mapped[]`) are prohibited.
    - **Session-based**: All DB operations go through `Session`, not raw `connection.execute()`.
    - **Connection URL**: Use `postgresql+psycopg://` dialect string.
    - **pgserver for Local Dev**: Use `pgserver` for embedded PostgreSQL. Store data directory in the configured `db/` path. Bind to TCP on localhost for external tool access (DBeaver).
    - **Existing SQLite Layer**: The `sqlbind` package and existing SQLite-based repositories remain untouched for backward compatibility with `pubmed_data_1` and `pubmed_data_2`.
16. **Modern Python Standards**:
    - **Pathlib Mandate**: Use `pathlib.Path` exclusively for all file and directory operations (joins, existence checks, directory creation, etc.). String-based path manipulation (e.g., `os.path.join`, `os.mkdir`, `os.remove`, or string concatenation for paths) is strictly prohibited. Use the `/` operator for joining paths.
    - **Metadata Integrity**: Metadata is critically important and MUST be preserved across all operations (copies, moves, transfers, etc.). When copying or moving files, always use methods that preserve original attributes (e.g., `shutil.copy2` instead of `shutil.copy`). This principle applies to all data handling: never discard, alter, or ignore metadata (timestamps, headers, internal tags) unless explicitly instructed.
    - **Modern String Formatting**: Use f-strings for all string interpolation. Avoid using `.format()` or `%` formatting unless required by external libraries.
    - **Modern Type Hinting**: Use modern Python 3.12+ built-in collection types for type hinting (e.g., `list[str]`, `dict[str, Any]`) instead of importing from the `typing` module (e.g., `List`, `Dict`).

#### Maintenance & Memory
1. **Guideline Ownership**: These rules are succinct and agent-authored for agent consumption. Updates are semantic; do not edit unless instructed.
2. **Semantic Memory**: Maintain `.junie/memory.md` for internal state tracking. Human-unreadable/ignored.
