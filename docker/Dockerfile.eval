# Copyright (c) 2026 Brothertown Language
FROM ghcr.io/astral-sh/uv:latest AS uv

FROM ubuntu:24.04

# Build args for host user
ARG USER_ID
ARG GROUP_ID
ARG USER_NAME

# Set timezone
ENV TZ=EST5EDT

# Create user matching host
RUN (groupadd -g ${GROUP_ID} ${USER_NAME} || groupmod -n ${USER_NAME} $(getent group ${GROUP_ID} | cut -d: -f1)) && \
    (useradd -l -u ${USER_ID} -g ${GROUP_ID} -m ${USER_NAME} || usermod -l ${USER_NAME} -d /home/${USER_NAME} -m $(getent passwd ${USER_ID} | cut -d: -f1))

# Install uv from the uv image
COPY --from=uv /uv /uvx /bin/

# Set workdir and ownership
WORKDIR /app
RUN chown ${USER_NAME}:${GROUP_ID} /app

# Switch to non-root user
USER ${USER_NAME}

# Set environment variables for uv
ENV UV_LINK_MODE=copy
ENV UV_PYTHON_INSTALL_DIR=/home/${USER_NAME}/.local/share/uv/python
ENV PATH="/home/${USER_NAME}/.local/bin:/app/.venv/bin:$PATH"

# Install Python and create venv using uv
RUN uv python install 3.12
RUN uv venv /app/.venv --python 3.12

# Install dependencies
COPY --chown=${USER_NAME}:${GROUP_ID} pyproject.toml /app/
RUN uv pip install transformers scikit-learn tqdm torch accelerate sentencepiece tiktoken

# Prepare app directory
RUN mkdir -p /app/docker.app

# Create outputs and cache directory structures to ensure proper permissions
RUN mkdir -p /app/outputs /home/${USER_NAME}/.cache/huggingface

# Set entrypoint to use uv run and fail immediately on errors
ENTRYPOINT ["uv", "run", "--python", "/app/.venv/bin/python"]
